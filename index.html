<html>
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
  </head>
  <body>
    <h1>Tetris - Rust and WebAssembly</h1>

    <canvas id="board"></canvas>

    <script type="module">
      import init, {
        Tetris,
        build_board
      } from './pkg/tetris_rust_wasm.js';

      let game;
      async function run() {
        await init();
        game = build_board(20, 10, 24)
      }
      run().then(() => {
        const tick_delay = 400;
        let last_tick = Date.now();;
        function mainLoop() {
          if ((Date.now() - last_tick) > tick_delay) {
            game.tick(); last_tick = Date.now();
          }
          if (!game.game_over) { requestAnimationFrame(mainLoop); }
        }
        requestAnimationFrame(mainLoop);

        function keyboardControls(event){
          if(event.keyCode == 37){
            game.move_left(); last_tick = Date.now();
          }else if(event.keyCode == 38){
            game.rotate(); last_tick = Date.now();
          }else if(event.keyCode == 39){
            game.move_right(); last_tick = Date.now();
          }else if(event.keyCode == 40){
            game.move_down();
          }
        }
        document.addEventListener("keydown", keyboardControls);
      })


    </script>
  </body>
</html>
